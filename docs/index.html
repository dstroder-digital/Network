<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Primal Network — Charlotte</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

<style>
:root{--bg:#0b0b0b;--panel:#0009;--border:rgba(255,255,255,.12);--text:#eef5ff;--muted:#a8b3c7;--blue:#29adff;--gold:#ffcc00;--poi:#f4a261;--med:#e76f51}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
#map{position:absolute;inset:0}
.hud{position:absolute;top:12px;left:12px;z-index:20;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.hud h3{margin:0 0 6px 0;font-size:15px} .hud small{color:var(--muted)}
.panel{position:absolute;top:12px;right:12px;z-index:20;width:min(380px,34vw);max-height:calc(100% - 24px);overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
.btnbar{display:flex;flex-wrap:wrap;gap:6px}
.btn{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#151515;color:var(--text);cursor:pointer;font-size:13px}
.btn.active{background:#1d2a36;border-color:#2c3a4b;color:#bfe1ff}
.switch{display:flex;align-items:center;gap:8px}
label small{color:var(--muted)}
.legend{display:flex;gap:10px;align-items:center;margin-top:6px}
.sw{width:24px;height:8px;border-radius:5px;background:var(--blue)}
.sw.gold{background:var(--gold)} .sw.poi{background:var(--poi)} .sw.med{background:var(--med)} .sw.flood{background:#7dd3fc}
.divider{height:1px;background:var(--border);margin:8px 0}
.props{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px}
.props table{width:100%;border-collapse:collapse}
.props td{padding:4px 0;border-bottom:1px dashed var(--border);vertical-align:top}
.props td:first-child{color:var(--muted);padding-right:8px;width:42%}
.tip{position:absolute;pointer-events:none;z-index:30;transform:translate(-50%,-120%);background:#0e1116;color:#fff;padding:6px 8px;border:1px solid var(--border);border-radius:8px;white-space:nowrap;font-size:12.5px;box-shadow:0 10px 30px #0006}
.hidden{display:none}
.range{width:100%}
</style>
</head>
<body>
<div id="map"></div>

<div class="hud">
  <h3>Primal Network (PMTiles)</h3>
  <small>Pan/zoom; drag + <kbd>Alt</kbd> to rotate. Hover = preview, click = pin.</small>
</div>

<div class="panel">
  <div class="row">
    <label>Basemap</label>
    <div class="btnbar" id="basemapBar">
      <button class="btn" data-basemap="none">None</button>
      <button class="btn active" data-basemap="dark">Dark</button>
      <button class="btn" data-basemap="osm">OSM</button>
    </div>
  </div>

  <div class="row">
    <label>Edge color</label>
    <div class="btnbar" id="colorBar">
      <button class="btn active" data-color="solid">Solid</button>
      <button class="btn" data-color="count">By count</button>
      <button class="btn" data-color="class">By class</button>
      <button class="btn" data-color="metric" id="metricBtn" style="display:none">By metric</button>
    </div>
  </div>

  <div class="row">
    <label>Edge filter</label>
    <div class="btnbar" id="filterBar">
      <button class="btn active" data-filter="all">All</button>
      <button class="btn" data-filter="top10">Top 10% (count)</button>
      <button class="btn" data-filter="top1">Top 1% (count)</button>
      <button class="btn" data-filter="metricTop" id="metricFilter" style="display:none">Top (metric)</button>
    </div>
  </div>

  <div class="row" id="metricRow" style="display:none">
    <label>Metric</label>
    <select id="metricSelect">
      <option value="betweenness">betweenness</option>
      <option value="degree">degree</option>
      <option value="closeness">closeness</option>
      <option value="pagerank">pagerank</option>
      <option value="community">community</option>
    </select>
  </div>

  <div class="btnbar" style="margin-top:6px">
    <button class="btn" id="toggleWeighted">Weighted edges</button>
    <button class="btn" id="toggleArrows">Show one-way arrows</button>
    <button class="btn" id="toggleNodes">Show nodes</button>
  </div>

  <div class="btnbar" style="margin-top:6px">
    <button class="btn" id="toggleFire">Fire stations</button>
    <button class="btn" id="toggleMedical">Medical facilities</button>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Flood overlays</label>
    <div class="btnbar">
      <button class="btn" id="toggleNFHL">NFHL</button>
      <button class="btn" id="toggleFuture">Future</button>
    </div>
  </div>
  <div class="row">
    <label>Flood opacity</label>
    <input class="range" type="range" id="floodOpacity" min="0" max="1" step="0.05" value="0.35">
  </div>

  <div class="btnbar" style="margin-top:6px">
    <button class="btn" id="toggleBaseline">Route: Baseline</button>
    <button class="btn" id="toggleFlooded">Route: Flooded</button>
  </div>

  <div class="legend">
    <span class="sw"></span><small>Edges</small>
    <span class="sw gold"></span><small>Weighted</small>
    <span class="sw poi"></span><small>Fire</small>
    <span class="sw med"></span><small>Medical</small>
    <span class="sw flood"></span><small>Flood areas</small>
  </div>

  <div class="divider"></div>
  <div class="props" id="propTable">(click an edge to pin its properties) — <a href="#" id="toggleRaw">show raw</a></div>
</div>

<div id="tip" class="tip hidden"></div>

<script>
(() => {
/* ---------- URLs (swap if needed) ---------- */
const PMTILES_URL = 'pmtiles://https://media.githubusercontent.com/media/dstroder-digital/Network/main/docs/data/app/edges.pmtiles';
const NODES_URL = 'https://dstroder-digital.github.io/Network/data/app/nodes.geojson';
const FIRE_URL  = 'https://dstroder-digital.github.io/Network/data/app/fire_stations.geojson';
const MED_URL   = 'https://dstroder-digital.github.io/Network/data/app/medical_facilities.geojson';
const NFHL_URL  = 'https://dstroder-digital.github.io/Network/data/app/nfhl_dissolved.geojson';
const FUTURE_URL= 'https://dstroder-digital.github.io/Network/data/app/future_flood_dissolved.geojson';
const ROUTE_BASE= 'https://dstroder-digital.github.io/Network/data/app/route_example_baseline.geojson';
const ROUTE_FLOOD='https://dstroder-digital.github.io/Network/data/app/route_example_flooded.geojson';
const ROUTE_STATS='https://dstroder-digital.github.io/Network/data/app/route_example_stats.json';
const METRICS_URL=null; // set to JSON if you generate metrics (see format below)

/* ---------- PMTiles protocol (guard) ---------- */
if (!window.__pmtilesProto) {
  window.__pmtilesProto = new pmtiles.Protocol();
  maplibregl.addProtocol('pmtiles', window.__pmtilesProto.tile);
}

/* ---------- Map ---------- */
const map = new maplibregl.Map({
  container:'map', hash:true, pitchWithRotate:true, dragRotate:true,
  style:{version:8, sources:{}, layers:[{id:'bg',type:'background',paint:{'background-color':'#0b0b0b'}}]},
  center:[-80.8431,35.2271], zoom:10
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.ScaleControl({maxWidth:160, unit:'imperial'}));

/* ---------- one-way arrow image ---------- */
const arrowSvg = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="white" opacity="0.75"><path d="M13 5l7 7-7 7v-4H4v-6h9V5z"/></svg>`);
map.on('load',()=>{ map.loadImage(arrowSvg,(e,img)=>{ if(!e) map.addImage('arrow', img,{sdf:false,pixelRatio:2}); }); });

/* ---------- Layer/state setup ---------- */
let SOURCE_LAYER='edges';
const tiles = new pmtiles.PMTiles(PMTILES_URL.replace('pmtiles://',''));
tiles.getMetadata().then(meta=>{
  const names=(meta?.vector_layers||[]).map(v=>v.id);
  if(names.length && !names.includes(SOURCE_LAYER)) SOURCE_LAYER=names[0];
}).catch(()=>{});

/* ---------- Colors ---------- */
const ramps = {
  solid:'#29adff',
  count:['interpolate',['linear'],['coalesce',['to-number',['get','count']],0],
         0,'#24496b',10,'#2f6f9b',50,'#3e8ec3',100,'#55b0ec',250,'#9ad0ff',500,'#cfe6ff'],
  class:['match',['downcase',['coalesce',['get','functional_class'],'']],
         'motorway','#ff7a00','trunk','#ffcc00','primary','#ffd34d','secondary','#66d17a',
         'tertiary','#8bd7a2','residential','#29adff','service','#b1b8c7','#29adff']
};

function edgePaint(){
  return {
    'line-color': ramps[colorMode] || ramps.solid,
    'line-width': ['interpolate',['linear'],['zoom'],
      8, ['max',0.3,['*',0.008,['sqrt',['coalesce',['to-number',['get','count']],0]]]],
      12,['max',1.0,['*',0.02,['sqrt',['coalesce',['to-number',['get','count']],0]]]],
      15,['max',2.0,['*',0.04,['sqrt',['coalesce',['to-number',['get','count']],0]]]]
    ],
    'line-opacity': 0.95
  };
}

/* ---------- UI state ---------- */
let basemap='dark', colorMode='solid', filterMode='all';
let metrics=null, metricName='betweenness', metricDomain=[0,1];
let showWeighted=false, showArrows=false, showNodes=false;
let showFire=false, showMed=false, showNFHL=false, showFuture=false;

/* ---------- Build base + edges ---------- */
map.on('load', async ()=>{
  addBasemap(basemap);

  map.addSource('edges', {type:'vector', url: PMTILES_URL});

  map.addLayer({ id:'edges-line', type:'line', source:'edges', 'source-layer':SOURCE_LAYER,
    layout:{'line-cap':'round','line-join':'round'}, paint: edgePaint()
  });

  // Weighted overlay (fixed: sits ABOVE edges and width truly scales)
  map.addLayer({ id:'edges-weighted', type:'line', source:'edges','source-layer':SOURCE_LAYER,
    layout:{'line-cap':'round','line-join':'round', 'visibility':'none'},
    paint:{
      'line-color':'#ffcc00','line-opacity':0.65,
      'line-width':['interpolate',['linear'],['coalesce',['to-number',['get','count']],0],
        0,0, 50,2, 100,3.2, 250,5, 500,7.5, 1000,11]
    }
  });

  // One-way arrows
  map.addLayer({ id:'oneway-arrows', type:'symbol', source:'edges','source-layer':SOURCE_LAYER,
    layout:{
      'symbol-placement':'line','symbol-spacing':60,'icon-image':'arrow','icon-size':0.6,
      'visibility':'none'
    },
    filter:['any',
      ['==',['downcase',['get','oneway']],'yes'],
      ['in',['to-string',['get','oneway']],['literal',['1','true','True']]]
    ],
    paint:{'icon-opacity':0.7}
  });

  // Nodes, POIs, Floods, Routes:
  addOptionalLayers();

  // Metrics (optional)
  if (METRICS_URL){
    try{
      const j = await (await fetch(METRICS_URL,{mode:'cors'})).json();
      metrics = Array.isArray(j) ? Object.fromEntries(j.map(o=>[String(o.id),o])) : j;
      document.getElementById('metricBtn').style.display='';
      document.getElementById('metricRow').style.display='';
      document.getElementById('metricFilter').style.display='';
      setMetricDomain();
    }catch(_){}
  }

  wireUI();
});

/* ---------- Optional layers ---------- */
async function addOptionalLayers(){
  // Nodes
  try{
    map.addSource('nodes',{type:'geojson',data:NODES_URL});
    map.addLayer({id:'nodes',type:'circle',source:'nodes',layout:{visibility:'none'},
      paint:{'circle-radius':['interpolate',['linear'],['zoom'],8,1.2,12,2.2,15,3.2],'circle-color':'#f4a261','circle-opacity':0.8,'circle-stroke-color':'#111','circle-stroke-width':0.5}
    });
    document.getElementById('toggleNodes').disabled=false;
  }catch(_){ document.getElementById('toggleNodes').disabled=true; }

  // Fire
  try{
    map.addSource('fire',{type:'geojson',data:FIRE_URL});
    map.addLayer({id:'fire',type:'circle',source:'fire',layout:{visibility:'none'},
      paint:{'circle-radius':['interpolate',['linear'],['zoom'],8,2,12,3.5,15,5],'circle-color':'#f4a261','circle-stroke-color':'#111','circle-stroke-width':0.5}
    });
    document.getElementById('toggleFire').disabled=false;
  }catch(_){ document.getElementById('toggleFire').disabled=true; }

  // Medical
  try{
    map.addSource('med',{type:'geojson',data:MED_URL});
    map.addLayer({id:'med',type:'circle',source:'med',layout:{visibility:'none'},
      paint:{'circle-radius':['interpolate',['linear'],['zoom'],8,2,12,3.5,15,5],'circle-color':'#e76f51','circle-stroke-color':'#111','circle-stroke-width':0.5}
    });
    document.getElementById('toggleMedical').disabled=false;
  }catch(_){ document.getElementById('toggleMedical').disabled=true; }

  // Floods (polygons)
  try{
    map.addSource('nfhl',{type:'geojson',data:NFHL_URL});
    map.addLayer({id:'nfhl',type:'fill',source:'nfhl',layout:{visibility:'none'},
      paint:{'fill-color':'#38bdf8','fill-opacity':0.35,'fill-outline-color':'#0ea5e9'}
    });
    document.getElementById('toggleNFHL').disabled=false;
  }catch(_){ document.getElementById('toggleNFHL').disabled=true; }

  try{
    map.addSource('future',{type:'geojson',data:FUTURE_URL});
    map.addLayer({id:'future',type:'fill',source:'future',layout:{visibility:'none'},
      paint:{'fill-color':'#22d3ee','fill-opacity':0.35,'fill-outline-color':'#06b6d4'}
    });
    document.getElementById('toggleFuture').disabled=false;
  }catch(_){ document.getElementById('toggleFuture').disabled=true; }

  // Routes
  try{
    map.addSource('route_base',{type:'geojson',data:ROUTE_BASE});
    map.addLayer({id:'route_base',type:'line',source:'route_base',layout:{visibility:'none'},paint:{'line-color':'#22c55e','line-width':4}});
    document.getElementById('toggleBaseline').disabled=false;
  }catch(_){ document.getElementById('toggleBaseline').disabled=true; }

  try{
    map.addSource('route_flood',{type:'geojson',data:ROUTE_FLOOD});
    map.addLayer({id:'route_flood',type:'line',source:'route_flood',layout:{visibility:'none'},paint:{'line-color':'#ef4444','line-width':4}});
    document.getElementById('toggleFlooded').disabled=false;
  }catch(_){ document.getElementById('toggleFlooded').disabled=true; }

  // Show route deltas if stats present
  try{
    const stats = await (await fetch(ROUTE_STATS,{mode:'cors'})).json();
    if (stats && stats.baseline && stats.flooded){
      const t = document.getElementById('propTable');
      t.insertAdjacentHTML('afterbegin',
        `<div style="margin-bottom:8px"><b>Example travel time:</b> baseline ${fmtMin(stats.baseline.minutes)} vs flooded ${fmtMin(stats.flooded.minutes)} — Δ ${fmtMin(stats.flooded.minutes - stats.baseline.minutes)}</div>`);
    }
  }catch(_){}
}

/* ---------- Basemap ---------- */
function addBasemap(mode){
  ['osm','dark'].forEach(id=>{ try{ if(map.getLayer(id)) map.removeLayer(id);}catch(e){} try{ if(map.getSource(id)) map.removeSource(id);}catch(e){} });
  if(mode==='osm'){
    map.addSource('osm',{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'© OpenStreetMap'});
    map.addLayer({id:'osm',type:'raster',source:'osm'}, 'edges-line');
  }else if(mode==='dark'){
    map.addSource('dark',{type:'raster',tiles:['https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png'],tileSize:256,attribution:'© Stadia Maps, © OpenMapTiles, © OpenStreetMap'});
    map.addLayer({id:'dark',type:'raster',source:'dark'}, 'edges-line');
  }
}

/* ---------- Filters ---------- */
function applyFilter(){
  if (!map.getLayer('edges-line')) return;
  let f = ['>=',['coalesce',['to-number',['get','count']],0], 0];
  if (filterMode==='top10'){
    f = ['>=',['coalesce',['to-number',['get','count']],0], ['*',0.9,['max',['to-number',['get','count']],0]]]; // heuristic
  } else if (filterMode==='top1'){
    f = ['>=',['coalesce',['to-number',['get','count']],0], ['*',0.99,['max',['to-number',['get','count']],0]]];
  } else if (filterMode==='metricTop' && metrics){
    // show only edges with metric >= p90 of domain
    const thr = metricDomain[0] + 0.90*(metricDomain[1]-metricDomain[0]);
    f = ['>=',['coalesce',['feature-state',metricName],['to-number',['get',metricName]],0], thr];
  }
  map.setFilter('edges-line', f);
  if (map.getLayer('edges-weighted')){
    map.setFilter('edges-weighted', ['all', f, ['>=',['coalesce',['to-number',['get','count']],0],250]]);
  }
}

/* ---------- Metrics ---------- */
function setMetricDomain(){
  const vals=[];
  for (const k in metrics){ const v=+metrics[k]?.[metricName]; if(Number.isFinite(v)) vals.push(v); }
  if (!vals.length) return;
  vals.sort((a,b)=>a-b);
  metricDomain=[vals[Math.floor(vals.length*0.02)], vals[Math.floor(vals.length*0.98)]];
}

/* ---------- UI wiring ---------- */
function wireUI(){
  // basemap
  document.getElementById('basemapBar').addEventListener('click', e=>{
    const b=e.target.closest('.btn'); if(!b) return; basemap=b.dataset.basemap; setActive(e.currentTarget,b); addBasemap(basemap);
  });

  // color
  const colorBar=document.getElementById('colorBar');
  colorBar.addEventListener('click', e=>{
    const b=e.target.closest('.btn'); if(!b) return; colorMode=b.dataset.color; setActive(colorBar,b);
    map.setPaintProperty('edges-line','line-color', colorMode==='metric' ? ['interpolate',['linear'],['coalesce',['feature-state',metricName],['to-number',['get',metricName]],0],
      metricDomain[0],'#264653',(metricDomain[0]+metricDomain[1])/2,'#2a9d8f',metricDomain[1],'#e9c46a'] : (ramps[colorMode]||ramps.solid));
  });

  // filter
  const filterBar=document.getElementById('filterBar');
  filterBar.addEventListener('click', e=>{
    const b=e.target.closest('.btn'); if(!b) return; filterMode=b.dataset.filter; setActive(filterBar,b); applyFilter();
  });

  // metric controls visibility
  if (metrics){ document.getElementById('metricBtn').style.display=''; document.getElementById('metricRow').style.display=''; document.getElementById('metricFilter').style.display=''; }

  document.getElementById('metricSelect').addEventListener('change', e=>{
    metricName=e.target.value; setMetricDomain(); if(colorMode==='metric'){ map.setPaintProperty('edges-line','line-color',
      ['interpolate',['linear'],['coalesce',['feature-state',metricName],['to-number',['get',metricName]],0],
      metricDomain[0],'#264653',(metricDomain[0]+metricDomain[1])/2,'#2a9d8f',metricDomain[1],'#e9c46a']); }
    applyFilter();
  });

  // toggles
  bindToggle('toggleWeighted', v=>{ showWeighted=v; map.setLayoutProperty('edges-weighted','visibility', v?'visible':'none'); });
  bindToggle('toggleArrows',   v=>{ showArrows=v;   map.setLayoutProperty('oneway-arrows','visibility', v?'visible':'none'); });
  bindToggle('toggleNodes',    v=>{ showNodes=v;    map.setLayoutProperty('nodes','visibility', v?'visible':'none'); });
  bindToggle('toggleFire',     v=>{ showFire=v;     map.setLayoutProperty('fire','visibility', v?'visible':'none'); });
  bindToggle('toggleMedical',  v=>{ showMed=v;      map.setLayoutProperty('med','visibility', v?'visible':'none'); });
  bindToggle('toggleNFHL',     v=>{ showNFHL=v;     map.setLayoutProperty('nfhl','visibility', v?'visible':'none'); });
  bindToggle('toggleFuture',   v=>{ showFuture=v;   map.setLayoutProperty('future','visibility', v?'visible':'none'); });
  bindToggle('toggleBaseline', v=>{ map.setLayoutProperty('route_base','visibility', v?'visible':'none'); });
  bindToggle('toggleFlooded',  v=>{ map.setLayoutProperty('route_flood','visibility', v?'visible':'none'); });

  // flood opacity
  document.getElementById('floodOpacity').addEventListener('input', e=>{
    const v=+e.target.value; if(map.getLayer('nfhl')) map.setPaintProperty('nfhl','fill-opacity', v);
    if(map.getLayer('future')) map.setPaintProperty('future','fill-opacity', v);
  });

  // detail table (raw toggle)
  document.getElementById('toggleRaw').addEventListener('click', e=>{
    e.preventDefault(); showRaw=!showRaw; renderProps(lastProps);
  });
}

/* ---------- Helpers ---------- */
function setActive(container, btn){ [...container.querySelectorAll('.btn')].forEach(b=>b.classList.toggle('active', b===btn)); }
function fmtMin(x){ const m=Math.round(x); return `${m} min`; }
function bindToggle(id, fn){ const el=document.getElementById(id); el.addEventListener('click', ()=>{ el.classList.toggle('active'); fn(el.classList.contains('active')); }); }

/* ---------- Tooltips + details (clean labels) ---------- */
const tipEl=document.getElementById('tip'); const propsEl=document.getElementById('propTable');
let showRaw=false, lastProps=null;
const LABELS={
  id:'ID', name:'Name', ref:'Ref', functional_class:'Class', count:'Traffic index',
  oneway:'Direction', lanes:'Lanes', maxspeed:'Max speed', surface:'Surface', divided:'Divided',
  zipcode:'ZIP'
};
const FORMAT={
  Direction:v=>{
    const y = String(v).toLowerCase();
    return (y==='yes'||y==='true'||y==='1') ? 'One-way' : 'Two-way';
  },
  'Max speed':v=> v? `${v} mph` : ''
};

function cleanProps(p){
  const out={}; for(const k in LABELS){
    const src=k, lab=LABELS[k]; let v=p?.[src];
    if(v==null || v==='') continue; if(FORMAT[lab]) v=FORMAT[lab](v); out[lab]=v;
  }
  // If metrics present, show a few
  if (metrics){
    const id = p?.id!=null ? String(p.id) : null;
    const m = id? metrics[id] : null;
    if (m){
      if (m.betweenness!=null) out['Betweenness'] = +m.betweenness;
      if (m.degree!=null) out['Degree'] = +m.degree;
      if (m.closeness!=null) out['Closeness'] = +m.closeness;
      if (m.pagerank!=null) out['PageRank'] = +m.pagerank;
      if (m.community!=null) out['Community'] = m.community;
    }
  }
  return out;
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function renderTable(obj){
  if (showRaw) { return `<pre style="white-space:pre-wrap">${esc(JSON.stringify(obj,null,2))}</pre>`; }
  const k=Object.keys(obj); if(!k.length) return '(no selected fields)';
  let h='<table>'; for(const x of k){ h+=`<tr><td>${esc(x)}</td><td>${esc(obj[x])}</td></tr>` } return h+'</table>';
}

map.on('mousemove', e=>{
  const f=map.queryRenderedFeatures(e.point,{layers:['edges-line','edges-weighted']})[0];
  if(!f){ if(!lastPinned){tipEl.classList.add('hidden');} return; }
  const nm=f.properties?.name||f.properties?.ref||'Edge';
  const cnt=+f.properties?.count;
  tipEl.innerHTML = `<strong>${esc(nm)}</strong>${Number.isFinite(cnt)?` — count: ${cnt}`:''}`;
  tipEl.style.left = e.originalEvent.clientX+'px'; tipEl.style.top = e.originalEvent.clientY+'px';
  tipEl.classList.remove('hidden');
});
let lastPinned=false;
map.on('click', e=>{
  const f=map.queryRenderedFeatures(e.point,{layers:['edges-line','edges-weighted']})[0];
  if(!f){ lastPinned=false; tipEl.classList.add('hidden'); propsEl.textContent='(click an edge to pin its properties)'; return; }
  lastPinned=true; lastProps=f.properties||{}; propsEl.innerHTML=renderTable(cleanProps(lastProps));
});

/* ---------- Metric painting via feature-state (if provided later) ---------- */
map.on('render', throttle(()=>{
  if (!metrics || colorMode!=='metric') return;
  const bbox=[[0,0],[map.getCanvas().width, map.getCanvas().height]];
  const feats = map.queryRenderedFeatures(bbox,{layers:['edges-line']});
  for (const f of feats){
    const id = f.id ?? f.properties?.id; if(id==null) continue;
    const m = metrics[String(id)]; if(!m) continue;
    map.setFeatureState({source:'edges',sourceLayer:SOURCE_LAYER,id:f.id}, m);
  }
  applyFilter();
}, 400));

function throttle(fn,wait){let t=0;return(...a)=>{const n=Date.now();if(n-t>wait){t=n;fn(...a);}}}
</script>
</body>
</html>
